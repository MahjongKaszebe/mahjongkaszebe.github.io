name: Discord to GitHub Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write
secrets: inherit

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Discord messages
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages?limit=10")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY" > messages.json

      - name: Process messages
        run: |
          pip install requests pyyaml > /dev/null 2>&1
          cat > process.py << 'PYEOF'
          import json
          import os
          import re

          with open('messages.json', 'r') as f:
              messages = json.load(f)

          processed_file = 'processed_messages.txt'
          if os.path.exists(processed_file):
              with open(processed_file, 'r') as f:
                  processed = set(line.strip() for line in f)
          else:
              processed = set()

          new_processed = []
          changes_made = False

          for msg in messages:
              msg_id = msg['id']
              if msg_id in processed:
                  continue
              
              content = msg['content']
              if not content.startswith('!event'):
                  continue
              
              lines = content.strip().split('\n')
              title = None
              date = None
              end_date = None
              section = 'wydarzenia'
              body_lines = []
              in_body = False
              
              for line in lines[1:]:
                  line = line.strip()
                  if line.startswith('title:'):
                      title = line.replace('title:', '').strip().strip('"')
                  elif line.startswith('date:'):
                      date = line.replace('date:', '').strip()
                  elif line.startswith('end_date:'):
                      end_date = line.replace('end_date:', '').strip().strip('"')
                  elif line.startswith('section:'):
                      section_line = line.replace('section:', '').strip()
                      section = 'blog' if section_line == 'blog' else 'wydarzenia'
                  elif line.startswith('---'):
                      in_body = True
                  elif in_body and line:
                      body_lines.append(line)
              
              if not title or not date:
                  print(f'Skipping {msg_id}: missing title or date')
                  continue
              
              slug = title.lower().replace(' ', '-')
              slug = re.sub(r'[^a-z0-9-]', '', slug)
              
              if section == 'blog':
                  folder = 'content/blog'
                  filename = f'{folder}/{slug}.md'
                  file_content = f'''+++
          title = "{title}"
          date = {date}
          +++

          {chr(10).join(body_lines)}
          '''
              else:
                  folder = 'content/wydarzenia'
                  filename = f'{folder}/{slug}.md'
                  if end_date:
                      file_content = f'''+++
          title = "{title}"
          date = {date}
          template = "event.html"

          [extra]
          end_date = "{end_date}"
          +++

          {chr(10).join(body_lines)}
          '''
                  else:
                      file_content = f'''+++
          title = "{title}"
          date = {date}
          template = "event.html"
          +++

          {chr(10).join(body_lines)}
          '''
              
              os.makedirs(folder, exist_ok=True)
              
              with open(filename, 'w') as f:
                  f.write(file_content)
              
              print(f'Created: {filename}')
              new_processed.append(msg_id)
              changes_made = True

          with open(processed_file, 'w') as f:
              for msg_id in processed.union(set(new_processed)):
                  f.write(f'{msg_id}\n')

          if changes_made:
              print('changed=true')
          else:
              print('No new events')
          PYEOF
                    python3 process.py

                - name: Commit changes
                  run: |
                    if [ -n "$(git status --porcelain)" ]; then
                      git config --local user.email "bot@github.com"
                      git config --local user.name "Discord Bot"
                      git add -A
                      git commit -m "Sync events from Discord $(date '+%Y-%m-%d %H:%M')" || echo "No changes"
                      git push
                    else
                      echo "No changes to push"
                    fi
