{% extends "base.html" %}

{% block title %}{{ section.title }} - {{ config.title }}{% endblock %}

{% block content %}
<h1>Kalendarz wydarzeń</h1>

<div id="calendar"></div>

<h2>Lista wydarzeń</h2>
<div id="events-list"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<style>
    #calendar {
        background: #FFE600;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 2px solid #000;
    }
    .fc {
        --fc-border-color: #000 !important;
        --fc-today-bg-color: rgba(255, 0, 0, 0.2);
        --fc-page-bg-color: #FFE600;
        --fc-neutral-bg-color: #FFE600;
        --fc-list-event-hover-bg-color: #FFE600;
        --fc-event-background-color: #000000;
        --fc-event-border-color: #000000;
        --fc-event-text-color: #FFE600;
    }
    .fc-event:hover {
        background-color: #8B0000 !important;
    }
    .fc-event:hover .fc-event-main {
        background-color: #8B0000 !important;
    }
    .fc-event:hover .fc-event-time {
        background-color: #8B0000 !important;
    }
    .fc-event:hover .fc-event-title {
        background-color: #8B0000 !important;
    }
    .fc-event {
        background-color: #000 !important;
        border-color: #000 !important;
        color: #FFE600 !important;
        font-weight: normal !important;
    }
    .fc-event .fc-event-main {
        background-color: #000 !important;
        color: #FFE600 !important;
        font-weight: normal !important;
    }
    .fc-event-title {
        font-weight: normal !important;
    }
    .fc-event-time {
        color: #FFE600 !important;
        background-color: #000 !important;
        padding: 0 2px;
        font-weight: normal !important;
    }
    .fc-daygrid-month-view .fc-daygrid-event-dot {
        display: none !important;
    }
    .fc-timegrid-view .fc-event-dot {
        border-color: #FF0000 !important;
    }
    .fc-timegrid-view .fc-event,
    .fc-timegrid-view .fc-event-title,
    .fc-timegrid-view .fc-event-title a,
    .fc-timeGridWeek-view .fc-event,
    .fc-timeGridWeek-view .fc-event .fc-event-main {
        background-color: #FFE600 !important;
        border-color: #000000 !important;
        color: #000000 !important;
    }
    .fc-timegrid-view .fc-event-dot {
        border-color: #FF0000 !important;
    }
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #000 !important;
    }
    .fc .fc-daygrid-day-number {
        color: #000;
    }
    .fc .fc-col-header-cell-cushion {
        color: #000;
    }
    .fc .fc-daygrid-day.fc-day-today {
        background-color: rgba(255, 0, 0, 0.2);
    }
    .fc-list-event {
        background-color: #000 !important;
        border-color: #FFE600 !important;
    }
    .fc-list-event td {
        background-color: #000 !important;
        border-color: #FFE600 !important;
    }
    .fc-list-event-title a {
        color: #FFE600 !important;
    }
    .fc-list-event-time {
        color: #FFE600 !important;
    }
    .fc-list-day-cushion {
        background-color: #FFE600 !important;
    }
    .fc-list-event:hover td {
        background-color: #8B0000 !important;
    }
    .fc-daygrid-event-dot,
    .fc-list-event-dot {
        border-color: #FF0000 !important;
    }
    .fc-button {
        background-color: #000 !important;
        border-color: #000 !important;
        color: #FFE600 !important;
    }
    .fc-button:hover {
        background-color: #8B0000 !important;
        border-color: #8B0000 !important;
    }
    .fc-button:focus,
    .fc-button:active {
        background-color: #FF0000 !important;
        border-color: #FF0000 !important;
        box-shadow: none !important;
    }
    .fc-button-active {
        background-color: #FF0000 !important;
    }
    .fc-button-active:hover {
        background-color: #CC0000 !important;
    }
    .fc-toolbar-title {
        color: #000 !important;
    }
    #events-list {
        background: #FFE600;
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid #000;
    }
    .event-item {
        padding: 1rem;
        border-bottom: 1px solid #000;
    }
    .event-item:last-child {
        border-bottom: none;
    }
    .event-date {
        font-weight: bold;
        color: #FF0000;
    }
</style>

<script src="/recurring-events.js"></script>
<script>
    // Static events from MD files
    const staticEvents = [
        {% for page in section.pages %}
        {
            title: "{{ page.title }}",
            start: "{{ page.date }}",
            {% if page.extra.end_date %}
            end: "{{ page.extra.end_date }}",
            {% endif %}
            {% if page.extra.schedule %}
            schedule: "{{ page.extra.schedule }}",
            cancelled: {{ page.extra.cancelled | json_encode() | safe }},
            {% endif %}
            allDay: true,
            url: "{{ config.base_url | safe }}{{ page.path | safe }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // Generate recurring events using Croner
    const recurringEvents = [];
    const recurringEventTitles = {}; // Track titles for list consolidation
    staticEvents.forEach(event => {
        if (event.schedule) {
            try {
                // Croner expects: second minute hour day month dayOfWeek
                // Our format: minute hour day month dayOfWeek (5 fields)
                const parts = event.schedule.split(' ');
                if (parts.length === 5) {
                    const [minute, hour, , , dayOfWeek] = parts;
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    const sixMonthsLater = new Date();
                    sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                    
                    // Generate all Tuesdays at the specified time
                    const current = new Date(oneWeekAgo);
                    current.setHours(parseInt(hour), parseInt(minute), 0, 0);
                    
                    // Find next occurrence
                    while (current.getDay() !== parseInt(dayOfWeek)) {
                        current.setDate(current.getDate() + 1);
                    }
                    
                    while (current <= sixMonthsLater) {
                        const dateStr = current.toISOString().slice(0, 16);
                        const isCancelled = event.cancelled && event.cancelled.includes(dateStr.split('T')[0]);
                        if (!isCancelled) {
                            recurringEvents.push({
                                ...event,
                                start: dateStr,
                                end: null,
                                title: event.title,
                                allDay: false,
                                isRecurring: true
                            });
                        }
                        current.setDate(current.getDate() + 7);
                    }
                    
                    // Store for list consolidation
                    recurringEventTitles[event.title] = true;
                }
            } catch (e) {
                console.error('Error generating recurring events:', e);
            }
        }
    });

    // Combine static and recurring events
    const events = [...staticEvents.filter(e => !e.schedule), ...recurringEvents];

    // Adjust end dates for FullCalendar (it treats end as exclusive, so add 1 day for inclusive)
    const calendarEvents = events.map(event => {
        if (event.end) {
            const end = new Date(event.end);
            end.setDate(end.getDate() + 1);
            return { ...event, end: end.toISOString().split('T')[0] };
        }
        return event;
    });

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            firstDay: 1,
            eventBackgroundColor: '#000000',
            eventBorderColor: '#000000',
            eventTextColor: '#FFE600',
            events: calendarEvents,
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) {
                    window.location.href = info.event.url;
                }
            },
            locale: 'pl',
            allDayText: 'Cały dzień',
            buttonText: {
                today: 'Dzisiaj',
                month: 'Miesiąc',
                week: 'Tydzień',
                day: 'Dzień',
                list: 'Tydzień'
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            }
        });
        calendar.render();

        const listEl = document.getElementById('events-list');
        const sortedEvents = [...events].sort((a, b) => new Date(a.start) - new Date(b.start));
        
        const processedRecurring = new Set();
        
            sortedEvents.forEach(event => {
            // Skip individual recurring events in list, we'll add consolidated entry
            if (event.isRecurring) {
                if (processedRecurring.has(event.title)) return;
                processedRecurring.add(event.title);
                
                const dateStr = formatRecurringDate(event.schedule);
                
                const item = document.createElement('div');
                item.className = 'event-item';
                item.innerHTML = `
                    <div class="event-date">${dateStr}</div>
                    <div><a href="${event.url}">${event.title}</a></div>
                `;
                listEl.appendChild(item);
                return;
            }
            
            const startDate = new Date(event.start);
            const endDate = event.end ? new Date(event.end) : null;
            
            const polishDaysShort = ['nie', 'pon', 'wt', 'śr', 'czw', 'pt', 'sob'];
            
            let dateStr;
            if (endDate && endDate.getTime() !== startDate.getTime()) {
                const startDay = polishDaysShort[startDate.getDay()];
                const endDay = polishDaysShort[endDate.getDay()];
                const year = startDate.getFullYear();
                if (startDate.getMonth() === endDate.getMonth()) {
                    dateStr = `${startDay} - ${endDay}, ${startDate.getDate()}-${endDate.getDate()} ${startDate.toLocaleDateString('pl-PL', { month: 'long' })} ${year}`;
                } else {
                    const startDateStr = startDate.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' });
                    const endDateStr = endDate.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' });
                    dateStr = `${startDay} - ${endDay}, ${startDateStr}-${endDateStr} ${year}`;
                }
            } else {
                dateStr = startDate.toLocaleDateString('pl-PL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            
            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `
                <div class="event-date">${dateStr}</div>
                <div><a href="${event.url}">${event.title}</a></div>
            `;
            listEl.appendChild(item);
        });
    });
</script>
{% endblock %}
